"use client";

import { useMemo, useState } from "react";
import { Button } from "@/components/shadcn/button";
import { TipsCard } from "@/features/tips/tips-card";
import { TipsText } from "@/features/tips/tips-text";

const HANDS = ["グー", "チョキ", "パー"] as const;
const ROUNDS = 1000;
const OPPONENT_ROCK_OPTIONS = [20, 33, 40, 50, 60, 70] as const;
const EXPLOIT_PLAYER_PROBS = [0, 0, 1] as const;
const GTO_PLAYER_PROBS = [1 / 3, 1 / 3, 1 / 3] as const;

type SimulationResult = {
  opponent: number[];
  player: number[];
  outcomes: {
    playerWin: number;
    draw: number;
    opponentWin: number;
  };
};

const pickHandByProbs = (probs: readonly number[]) => {
  const r = Math.random();
  let acc = 0;
  for (let i = 0; i < probs.length; i += 1) {
    acc += probs[i];
    if (r <= acc) return i;
  }
  return probs.length - 1;
};

const getOutcome = (player: number, opponent: number) => {
  if (player === opponent) return 0;
  if (
    (player === 0 && opponent === 1) ||
    (player === 1 && opponent === 2) ||
    (player === 2 && opponent === 0)
  ) {
    return 1;
  }
  return -1;
};

const buildOpponentProbs = (rockPercent: number) => {
  const rockRatio = rockPercent / 100;
  const remain = (1 - rockRatio) / 2;
  return [rockRatio, remain, remain] as const;
};

const simulateMatchup = (
  opponentProbs: readonly number[],
  playerProbs: readonly number[],
): SimulationResult => {
  const opponent = Array.from({ length: 3 }, () => 0);
  const player = Array.from({ length: 3 }, () => 0);
  const outcomes = { playerWin: 0, draw: 0, opponentWin: 0 };

  for (let i = 0; i < ROUNDS; i += 1) {
    const opponentHand = pickHandByProbs(opponentProbs);
    const playerHand = pickHandByProbs(playerProbs);
    opponent[opponentHand] += 1;
    player[playerHand] += 1;

    const outcome = getOutcome(playerHand, opponentHand);
    if (outcome === 0) outcomes.draw += 1;
    if (outcome === 1) outcomes.playerWin += 1;
    if (outcome === -1) outcomes.opponentWin += 1;
  }

  return { opponent, player, outcomes };
};

export const Main = () => {
  const [opponentRockRate, setOpponentRockRate] = useState<
    (typeof OPPONENT_ROCK_OPTIONS)[number]
  >(OPPONENT_ROCK_OPTIONS[3]);
  const opponentProbs = useMemo(
    () => buildOpponentProbs(opponentRockRate),
    [opponentRockRate],
  );
  const [exploitResult, setExploitResult] = useState<SimulationResult>(() =>
    simulateMatchup(
      buildOpponentProbs(OPPONENT_ROCK_OPTIONS[3]),
      EXPLOIT_PLAYER_PROBS,
    ),
  );
  const [gtoResult, setGtoResult] = useState<SimulationResult>(() =>
    simulateMatchup(
      buildOpponentProbs(OPPONENT_ROCK_OPTIONS[3]),
      GTO_PLAYER_PROBS,
    ),
  );

  const exploitEdge = useMemo(
    () => exploitResult.outcomes.playerWin - exploitResult.outcomes.opponentWin,
    [exploitResult.outcomes.playerWin, exploitResult.outcomes.opponentWin],
  );
  const gtoEdge = useMemo(
    () => gtoResult.outcomes.playerWin - gtoResult.outcomes.opponentWin,
    [gtoResult.outcomes.playerWin, gtoResult.outcomes.opponentWin],
  );

  const handleResimulate = () => {
    setExploitResult(simulateMatchup(opponentProbs, EXPLOIT_PLAYER_PROBS));
    setGtoResult(simulateMatchup(opponentProbs, GTO_PLAYER_PROBS));
  };

  const handleRockRateChange = (
    rate: (typeof OPPONENT_ROCK_OPTIONS)[number],
  ) => {
    setOpponentRockRate(rate);
    const probs = buildOpponentProbs(rate);
    setExploitResult(simulateMatchup(probs, EXPLOIT_PLAYER_PROBS));
    setGtoResult(simulateMatchup(probs, GTO_PLAYER_PROBS));
  };

  return (
    <>
      <section className="space-y-3">
        <TipsText>
          相手がグーを多めに出していると分かれば、パーを多めに出すのが
          エクスプロイト (搾取)
          戦略です。グーの比率を変えて、期待値の変化を観察します。
        </TipsText>
        <TipsText>
          相手のチョキとパーは、残りの確率を半分ずつに配分します。
          こちらはパーを 100% 出すエクスプロイトと、GTO (1/3 ずつ出す) の両方で
          1000 回じゃんけんを繰り返します。
        </TipsText>
      </section>

      <TipsCard asChild className="rounded-xl bg-card/80">
        <section>
          <div className="flex flex-wrap items-center justify-between gap-3">
            <div>
              <p className="font-semibold text-sm">
                1000 回のエクスプロイトを実行
              </p>
              <p className="text-muted-foreground text-xs">
                相手の偏りを利用して期待値を上げます
              </p>
            </div>
            <Button size="sm" onClick={handleResimulate}>
              もう一度まわす
            </Button>
          </div>
          <div className="mt-4 rounded-full bg-muted/70 p-1">
            <div className="flex flex-wrap gap-1">
              {OPPONENT_ROCK_OPTIONS.map((rate) => (
                <Button
                  key={rate}
                  size="sm"
                  className={
                    rate === opponentRockRate
                      ? "rounded-full px-4"
                      : "rounded-full px-4 text-muted-foreground"
                  }
                  variant={rate === opponentRockRate ? "default" : "ghost"}
                  onClick={() => handleRockRateChange(rate)}
                >
                  グー {rate}%
                </Button>
              ))}
            </div>
          </div>
          <div className="mt-3 flex flex-wrap items-center gap-4 text-muted-foreground text-xs">
            <p>
              試行回数: <span className="font-semibold">{ROUNDS}</span>
            </p>
            <p>
              相手のグー比率:{" "}
              <span className="font-semibold">{opponentRockRate}%</span>
            </p>
            <p>
              相手のチョキ/パー:{" "}
              <span className="font-semibold">
                {((1 - opponentProbs[0]) * 50).toFixed(1)}% /{" "}
                {((1 - opponentProbs[0]) * 50).toFixed(1)}%
              </span>
            </p>
            <p>
              こちらの戦略: <span className="font-semibold">パー 100%</span>
            </p>
            <p>
              比較する戦略:{" "}
              <span className="font-semibold">GTO (各 33.3%)</span>
            </p>
          </div>
        </section>
      </TipsCard>

      <section className="grid gap-6 lg:grid-cols-2">
        <TipsCard className="space-y-4">
          <h2 className="font-semibold">相手の手の分布</h2>
          <div className="space-y-3">
            {HANDS.map((hand, index) => {
              const count = exploitResult.opponent[index];
              const percent = (count / ROUNDS) * 100;
              return (
                <div key={`opp-${hand}`} className="flex items-center gap-3">
                  <div className="w-12 font-semibold text-sm">{hand}</div>
                  <div className="h-2 flex-1 rounded-full bg-muted">
                    <div
                      className="h-2 rounded-full bg-amber-500 transition-[width] duration-700 ease-out"
                      style={{ width: `${percent}%` }}
                    />
                  </div>
                  <div className="w-28 whitespace-nowrap text-right text-sm tabular-nums">
                    {count} 回 ({percent.toFixed(1)}%)
                  </div>
                </div>
              );
            })}
          </div>
        </TipsCard>

        <TipsCard className="space-y-4">
          <h2 className="font-semibold">こちらの手の分布 (エクスプロイト)</h2>
          <div className="space-y-3">
            {HANDS.map((hand, index) => {
              const count = exploitResult.player[index];
              const percent = (count / ROUNDS) * 100;
              return (
                <div key={`player-${hand}`} className="flex items-center gap-3">
                  <div className="w-12 font-semibold text-sm">{hand}</div>
                  <div className="h-2 flex-1 rounded-full bg-muted">
                    <div
                      className="h-2 rounded-full bg-emerald-500 transition-[width] duration-700 ease-out"
                      style={{ width: `${percent}%` }}
                    />
                  </div>
                  <div className="w-28 whitespace-nowrap text-right text-sm tabular-nums">
                    {count} 回 ({percent.toFixed(1)}%)
                  </div>
                </div>
              );
            })}
          </div>
        </TipsCard>
      </section>

      <section className="grid gap-4 md:grid-cols-2">
        <TipsCard className="space-y-3">
          <h2 className="font-semibold">勝敗の内訳 (エクスプロイト)</h2>
          <div className="space-y-2 text-sm">
            <div className="flex items-center justify-between">
              <span>こちらの勝ち</span>
              <span className="font-semibold tabular-nums">
                {exploitResult.outcomes.playerWin} 回 (
                {((exploitResult.outcomes.playerWin / ROUNDS) * 100).toFixed(1)}
                %)
              </span>
            </div>
            <div className="flex items-center justify-between">
              <span>引き分け</span>
              <span className="font-semibold tabular-nums">
                {exploitResult.outcomes.draw} 回 (
                {((exploitResult.outcomes.draw / ROUNDS) * 100).toFixed(1)}%)
              </span>
            </div>
            <div className="flex items-center justify-between">
              <span>相手の勝ち</span>
              <span className="font-semibold tabular-nums">
                {exploitResult.outcomes.opponentWin} 回 (
                {((exploitResult.outcomes.opponentWin / ROUNDS) * 100).toFixed(
                  1,
                )}
                %)
              </span>
            </div>
          </div>
        </TipsCard>

        <TipsCard className="space-y-3 bg-emerald-50/80 text-emerald-900 text-sm shadow-none">
          <h2 className="font-semibold">エクスプロイトの効果</h2>
          <p>
            勝ち数 - 負け数:{" "}
            <span className="font-semibold">{exploitEdge}</span> 回
          </p>
          <p className="text-emerald-800 text-xs">
            相手が均衡から外れているほど、エクスプロイトの利益が大きくなります。
          </p>
        </TipsCard>
      </section>

      <section className="grid gap-4 md:grid-cols-2">
        <TipsCard className="space-y-3">
          <h2 className="font-semibold">勝敗の内訳 (GTO)</h2>
          <div className="space-y-2 text-sm">
            <div className="flex items-center justify-between">
              <span>こちらの勝ち</span>
              <span className="font-semibold tabular-nums">
                {gtoResult.outcomes.playerWin} 回 (
                {((gtoResult.outcomes.playerWin / ROUNDS) * 100).toFixed(1)}%)
              </span>
            </div>
            <div className="flex items-center justify-between">
              <span>引き分け</span>
              <span className="font-semibold tabular-nums">
                {gtoResult.outcomes.draw} 回 (
                {((gtoResult.outcomes.draw / ROUNDS) * 100).toFixed(1)}%)
              </span>
            </div>
            <div className="flex items-center justify-between">
              <span>相手の勝ち</span>
              <span className="font-semibold tabular-nums">
                {gtoResult.outcomes.opponentWin} 回 (
                {((gtoResult.outcomes.opponentWin / ROUNDS) * 100).toFixed(1)}
                %)
              </span>
            </div>
          </div>
        </TipsCard>

        <TipsCard className="space-y-3 bg-sky-50/80 text-sky-900 text-sm shadow-none">
          <h2 className="font-semibold">GTO の結果</h2>
          <p>
            勝ち数 - 負け数: <span className="font-semibold">{gtoEdge}</span> 回
          </p>
          <p className="text-sky-800 text-xs">
            均衡戦略は搾取されにくい一方で、相手の偏りから利益を取り切りにくいです。
          </p>
        </TipsCard>
      </section>
    </>
  );
};
